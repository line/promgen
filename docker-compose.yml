version: '3'
services:
  # Promgen services

  web:
    image: line/promgen
    depends_on:
      - "mysql"
      - "redis"
    environment:
      DEBUG: 1
      CELERY_BROKER_URL: redis://redis:6379/0
      DATABASE_URL: mysql://root:secretrootpassword@mysql:3306/promgen
      SECRET_KEY: some-secret-key-AhvSh+xGkm9kA,ghfi4?w8K
    command: promgen runserver 0.0.0.0:8000
    volumes:
      - ./promgen:/etc/promgen
    ports:
      - "8000:8000"

  worker:
    image: line/promgen
    depends_on:
      - "mysql"
      - "redis"
    environment:
      CELERY_BROKER_URL: redis://redis:6379/0
      DATABASE_URL: mysql://root:secretrootpassword@mysql:3306/promgen
      SECRET_KEY: some-secret-key-AhvSh+xGkm9kA,ghfi4?w8K
    command: worker -l info --queues celery,prometheus
    volumes:
      - ./prometheus:/etc/prometheus
      - ./promgen:/etc/promgen

  # Prometheus services

  prometheus:
    image: prom/prometheus
    command:
      - "--web.enable-lifecycle"
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus:/etc/prometheus

  blackbox:
    image: prom/blackbox-exporter
    volumes:
      - ./prometheus:/etc/prometheus

  alertmanager:
    image: prom/alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager:/etc/alertmanager

  # Database Services

  mysql:
    image: mariadb
    environment:
      MYSQL_ROOT_PASSWORD: secretrootpassword
      MYSQL_DATABASE: promgen

  redis:
    image: redis
