version: '3'
services:
  web:
    image: line/promgen
    external_links:
      - backend_mysql_1:mysql
      - backend_redis_1:redis
    environment:
      DEBUG: 1
      CELERY_BROKER_URL: redis://redis:6379/0
      DATABASE_URL: mysql://root:secretrootpassword@mysql:3306/promgen
      SECRET_KEY: some-secret-key-AhvSh+xGkm9kA,ghfi4?w8K
    command: promgen runserver 0.0.0.0:8000
    volumes:
      - ./promgen:/etc/promgen
    ports:
      - "8000:8000"
    networks:
      - backend
      - default

  worker:
    image: line/promgen
    external_links:
      - backend_mysql_1:mysql
      - backend_redis_1:redis
    environment:
      CELERY_BROKER_URL: redis://redis:6379/0
      DATABASE_URL: mysql://root:secretrootpassword@mysql:3306/promgen
      SECRET_KEY: some-secret-key-AhvSh+xGkm9kA,ghfi4?w8K
    command: worker -l info --queues celery,prometheus
    volumes:
      - ./prometheus:/etc/prometheus
      - ./promgen:/etc/promgen
    networks:
      - backend
      - default

  prometheus:
    image: prom/prometheus
    command: ["--web.enable-lifecycle", "--config.file=/etc/prometheus/prometheus.yml", "--storage.tsdb.path=/prometheus", "--web.console.libraries=/usr/share/prometheus/console_libraries", "--web.console.templates=/usr/share/prometheus/consoles"]
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus:/etc/prometheus
    networks:
      - default

  blackbox:
    image: prom/blackbox-exporter
    volumes:
      - ./prometheus:/etc/prometheus
    networks:
      - default

  alertmanager:
    image: prom/alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager:/etc/alertmanager
    networks:
      - default

networks:
  default:
  backend:
    external:
      name: backend_default

